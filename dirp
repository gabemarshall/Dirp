#!/usr/bin/env node

var argv = require("yargs").argv,
  http = require("./modules/http"),
  color = require("cli-color"),
  payloads = require("./modules/loadPayloads"),
  async = require("async"),
  fs = require("fs"),
  throttledQueue = require("throttled-queue"),
  rate = 100;

(dictionaryFile = "./default.txt"),
  (testString = ""),
  (debug = false),
  (jobs = 0),
  (jobsCount = 0),
  (test = false),
  (count = 0),
  (wordDir = require.resolve("cli-color"));

wordDir = wordDir.split("node_modules");
wordDir = wordDir[0];

var dictionaryFile = wordDir + "default.txt";

if (argv.rate) {
  rate = parseInt(argv.rate);
}

var throttle = throttledQueue(rate, 1000, true);

if (argv.help || argv.h || !argv.u) {
  console.log(color.green("\n--[Dirp Examples]--\n"));
  console.log("./dirp -u 'https://foo.bar/' --input=/path/to/wordlist.txt");
  console.log("./dirp -u 'https://foo.bar/<INSERT>.jsp'");
  console.log(
    "./dirp -u 'https://foo.bar/' --cookie='sessionid=12345;foo=bar;'"
  );
  console.log("./dirp -u 'https://foo.bar/' --proxy='http://proxy.host:port'");
  console.log("           '--rate=100 (max number of requests per second)");
  console.log();
} else if (argv.u) {
  if (argv.cookie) {
    http.cookies(argv.cookie);
  }

  if (argv.input || argv.wordlist) {
    if (argv.input) {
      dictionaryFile = argv.input;
    } else {
      dictionaryFile = argv.wordlist;
    }
  }

  if (argv.string) {
    testString = argv.string;
  }

  if (argv.debug) {
    debug = true;
  }

  fs.readFile(dictionaryFile, "utf8", function(err, data) {
    
    var payloadArray = data.toString().split("\n");
    
    const jobCount = payloadArray.length
    if (jobCount <= rate){
      console.log("woops")
      process.exit(0)
      rate = jobCount;
    }
    console.log(
      "\n[*] Using default wordlist which contains %s checks\n",
      payloadArray.length
    );

    var arrays = [];

    var httpjob = function(args) {
      if (argv.u.match(/((<INSERT\s*?.*?>))/gi)) {
        var payload = argv.u.replace(/((<INSERT\s*?.*?>))/gi, args[0]);
        http.get(argv.u, args, testString, debug, payload);
      } else {
        http.get(argv.u, args, testString, debug);
      }
    };
    
    for (var i = 0; i < payloadArray.length; i++) {
      throttle(function() {
        pay = payloadArray.splice(0, 1)
        httpjob(pay[0])
      });
    }
    setInterval(function(){
      
      count = jobCount - payloadArray.length;
      
      if ((count % rate) === 0) {
        var perCompleted = Math.round(((count / jobCount) * 100));
        perCompleted = perCompleted.toString();
        perCompleted += '% completed';
        if ((count % 1000) === 0){
          console.log("[*] "+perCompleted);
        }
          // console.log("foo")

      }
      if (payloadArray.length === 0){
        setTimeout(function(){
          process.exit(0)
        })
      }
    }, 1000)
  });
}
process.on('exit', function() {
  console.log("%s checks completed", count);
});